<h2>Catalog Page</h2>

<div id="status-message">
  {% if message %}
    <p id="upload-status-msg"><strong>Status:</strong> {{ message }}</p>
  {% endif %}
</div>

<p>Upload a playbook.</p>

<form
  id="upload-form"
  enctype="multipart/form-data"
  onsubmit="submitUploadForm(event)"
>
  <label for="playbook-file">Upload Playbook:</label>
  <input type="file" name="playbook_file" id="playbook-file" required />
  <button type="submit">Upload</button>
</form>

<hr />

<script>
  async function submitUploadForm(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);

    try {
      const response = await fetch("/catalog/upload", {
        method: "POST",
        body: formData
      });

      const data = await response.json();

      if (data.table_html) {
        document.getElementById('catalog-table').outerHTML = data.table_html;
      }

      if (data.status_html) {
        document.getElementById('status-message').innerHTML = data.status_html;

        const statusEl = document.getElementById('upload-status-msg');
        if (statusEl) {
          setTimeout(() => {
            statusEl.style.opacity = 0;
            setTimeout(() => statusEl.remove(), 300);
          }, 3000);
        }
      }
    } catch (err) {
      console.error("Upload error:", err);
      document.getElementById('status-message').innerHTML = "<p><strong>Error:</strong> Failed to upload playbook.</p>";
    }
  }
</script>

{% include "catalog_table.html" %}