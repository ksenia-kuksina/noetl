<h2 class="text-2xl font-semibold text-blue-700 mb-4">Catalog Page</h2>

<div id="status-message" class="mb-4">
  {% if message %}
  <p id="upload-status-msg" class="bg-blue-100 text-blue-800 px-4 py-2 rounded shadow-sm">
    <strong>Status:</strong> {{ message }}
  </p>
  {% endif %}
</div>

<form id="upload-form" enctype="multipart/form-data" onsubmit="submitUploadForm(event)"
  class="flex flex-col sm:flex-row sm:items-center gap-4 mb-6">
  <label for="playbook-file" class="text-gray-700 font-medium">Upload Playbook:</label>
  <input type="file" name="playbook_file" id="playbook-file" required
    class="block w-full sm:w-auto border border-gray-300 rounded px-3 py-2 text-sm shadow-sm file:mr-4 file:py-2 file:px-4 file:border-0 file:rounded file:bg-blue-600 file:text-white hover:file:bg-blue-700 transition" />
  <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-medium px-4 py-2 rounded shadow">
    Upload
  </button>
</form>

<hr class="border-gray-300 mb-6" />

{% include "catalog_table.html" %}


<script>
  async function submitUploadForm(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);

    try {
      const response = await fetch("/catalog/upload", {
        method: "POST",
        body: formData
      });

      const data = await response.json();

      if (data.table_html) {
        document.getElementById('catalog-table').outerHTML = data.table_html;
      }

      if (data.status_html) {
        document.getElementById('status-message').innerHTML = data.status_html;

        const statusEl = document.getElementById('upload-status-msg');
        if (statusEl) {
          await new Promise((resolve) => setTimeout(resolve, 3000));
          statusEl.style.opacity = 0;
          await new Promise((resolve) => setTimeout(resolve, 300));
          statusEl.remove();
        }
      }
    } catch (err) {
      console.error("Upload error:", err);
      document.getElementById('status-message').innerHTML =
        `
        <p class="bg-red-100 text-red-800 px-4 py-2 rounded shadow-sm">
          <strong>Error:</strong> Failed to upload playbook.
        </p>
        `;
    }
  }
</script>