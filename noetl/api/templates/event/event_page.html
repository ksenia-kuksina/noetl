<h2 class="text-2xl font-semibold text-blue-700 mb-4">Events Page</h2>

<div id="status-message" class="mb-4">
  {% if message %}
    <p id="event-status-msg" class="bg-blue-100 text-blue-800 px-4 py-2 rounded shadow-sm">
      <strong>Status:</strong> {{ message }}
    </p>
  {% endif %}
</div>

<form id="event-filter-form" method="get" action="/events" hx-get="/events" hx-target="#content" hx-include="#event-filter-form" class="space-y-4 mb-6">
  <label>
    Event ID:
    <input type="text" name="event_id" id="event_id" value="{{ search.get('event_id', '') }}" placeholder="Filter by Event ID"
           class="border px-3 py-2 rounded w-1/4" />
  </label>
  <label>
    Execution ID:
    <input type="text" name="execution_id" value="{{ search.get('execution_id', '') }}" placeholder="Filter by Execution ID"
           class="border px-3 py-2 rounded w-1/4" />
  </label>
  <label>
    Context ID:
    <input type="text" name="context_id" value="{{ search.get('context_id', '') }}" placeholder="Filter by Context ID"
           class="border px-3 py-2 rounded w-1/4" />
  </label>
  <label>
    Registry ID:
    <input type="text" name="registry_id" value="{{ search.get('registry_id', '') }}" placeholder="Filter by Registry ID"
           class="border px-3 py-2 rounded w-1/4" />
  </label>
  <label>
    Event Message:
    <input type="text" name="event_message" value="{{ search.get('event_message', '') }}" placeholder="Filter by Event Message"
           class="border px-3 py-2 rounded w-1/4" />
  </label>
  <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
    Search
  </button>
  <button type="reset" hx-get="/events" hx-target="#content" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded">
    Reset
  </button>
</form>

<div id="events-table">
  {% include "event_table.html" %}
</div>

<script>
  async function triggerJob(resourcePath, resourceVersion) {
    const payload = {
      meta: {
        resource_path: resourcePath,
        resource_version: resourceVersion
      },
      event_type: "JobTrigger",
      event_state: "REQUESTED"
    };

    try {
      const response = await fetch('/events/emit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (response.ok) {
        const result = await response.json();
        if (result.event_id) {
          const queryParams = new URLSearchParams({
            event_id: result.event_id,
            execution_id: result.execution_id || '',
            context_id: result.context_id || '',
            registry_id: result.registry_id || ''
          });
          const url = '/events?' + queryParams.toString();
          document.querySelector('#content').setAttribute('hx-get', url);
          htmx.trigger(htmx.find('#content'), 'load');
        } else {
          alert("Job triggered but no job ID returned.");
        }
      } else {
        alert("Failed to trigger job: " + response.statusText);
      }
    } catch (error) {
      alert("Error sending event: " + error);
    }
  }
</script>