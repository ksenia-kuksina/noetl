apiVersion: noetl.io/v1
kind: Playbook
name: postgres_csv_workflow
path: /playbooks/postgres_csv_workflow

environment:
  dbHost: "localhost"
  dbPort: 5432
  dbName: "test_db"
  dbUser: "test_user"
  dbPassword: "secure_password"
  outputCsvPath: "data/exported_data.csv"
  logPath: "logs/postgres_csv_{{ context.jobId }}.log"
  logLevel: INFO

context:
  jobId: "{{ generate_uuid() }}"
  steps:
    - name: initialize_db
      status: READY
  state: NEW

tasks:
  - name: create_table
    run:
      - action: create_table
        method: postgres
        desc: "Create table in PostgreSQL database"
        query: |
          CREATE TABLE IF NOT EXISTS users (
              user_id SERIAL PRIMARY KEY,
              username VARCHAR(50),
              email VARCHAR(100),
              created_at TIMESTAMP DEFAULT NOW()
          );

  - name: insert_record
    run:
      - action: insert_record
        method: postgres
        desc: "Insert a record into PostgreSQL database"
        query: |
          INSERT INTO users (username, email)
          VALUES ('johndoe', 'john@example.com');

  - name: export_to_csv
    run:
      - action: export_csv
        method: postgres_to_csv
        desc: "Export data from PostgreSQL table to CSV"
        query: "SELECT * FROM users;"
        output: "{{ environment.outputCsvPath }}"
        includeHeaders: true

  - name: handle_error_task
    run:
      - action: log
        method: log
        desc: "Log error message"
        message: "{{ error.message }}"
        level: ERROR

steps:
  - name: initialize_db
    mode: sequential
    when: "{{ event.type == 'workflow_started' and event.jobId == context.jobId }}"
    run:
      - task: create_table
      - task: insert_record
    next:
      - when: "{{ result.success }}"
        run:
          - step: export_step
      - when: "{{ not result.success }}"
        run:
          - step: handle_error

  - name: export_step
    mode: sequential
    run:
      - task: export_to_csv
    next:
      - run: []

  - name: handle_error
    mode: sequential
    run:
      - task: handle_error_task
    next:
      - run: []
